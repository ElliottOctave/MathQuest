<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profile Picture Shop</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="../pages/styles/style.css">
  <link rel="stylesheet" href="../pages/styles/mathQuest.css">
  <link rel="stylesheet" href="../pages/styles/games/shop.css">

</head>
<body>

  <!-- âœ… HEADER -->
  <div id="header"></div>

  <!-- ðŸ§¸ SHOP CONTENT -->
  <div class="header-content">
    <h1>ðŸ§¸ Choose Your Profile Picture</h1>
    <div id="coinCount">ðŸª™ 0 Coins</div>
  </div>

  <div class="grid" id="pictureGrid">
    <!-- Cards will be injected here -->
  </div>

  <!-- âœ… FOOTER -->
  <div id="footer"></div>

  <!-- Scripts -->
  <script type="module">
    import { auth, db } from "../firebase.js";
    import { doc, getDoc, updateDoc } from "firebase/firestore";

    const animalPics = [
      "bear.webp", "cooper.png", "dot.png", "fox.png", "lemur.webp", 
      "monkey.png", "professor.png", "rabbit.webp", "timmy.webp", "zuri.png"
    ];

    const displayNames = animalPics.map(name => name.split(".")[0]);

    let userData, userRef, uid;
    let userCoins = 0;
    let owned = [];

    async function initShop() {
      auth.onAuthStateChanged(async user => {
        if (!user) return alert("Please log in.");
        uid = user.uid;
        userRef = doc(db, "users", uid);
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) return;

        userData = userSnap.data();
        userCoins = userData.coins || 0;
        owned = userData.profile_pictures || Array(animalPics.length).fill(0);

        document.getElementById("coinCount").textContent = `ðŸª™ ${userCoins} Coins`;
        renderGrid();
      });
    }

    function renderGrid() {
      const grid = document.getElementById("pictureGrid");
      grid.innerHTML = "";

      animalPics.forEach((pic, i) => {
        const card = document.createElement("div");
        card.className = "picture-card" + (owned[i] ? " owned" : "");

        const img = document.createElement("img");
        img.src = `/pages/assets/animals/${pic}`;
        img.alt = displayNames[i];

        const title = document.createElement("div");
        title.textContent = displayNames[i].charAt(0).toUpperCase() + displayNames[i].slice(1);

        card.appendChild(img);
        card.appendChild(title);

        if (owned[i]) {
          const ownedMsg = document.createElement("div");
          ownedMsg.innerHTML = "âœ… Owned";
          card.appendChild(ownedMsg);
        } else {
          const btn = document.createElement("button");
          btn.textContent = "Buy for 20 ðŸª™";
          btn.className = "btn btn-sm btn-primary buy-btn";
          btn.onclick = () => buyPicture(i);
          card.appendChild(btn);
        }

        grid.appendChild(card);
      });
    }

    async function buyPicture(index) {
      if (owned[index]) return alert("Already owned.");
      if (userCoins < 20) return alert("Not enough coins!");

      userCoins -= 20;
      owned[index] = 1;

      await updateDoc(userRef, {
        coins: userCoins,
        profile_pictures: owned
      });

      document.getElementById("coinCount").textContent = `ðŸª™ ${userCoins} Coins`;
      renderGrid();
      alert("ðŸŽ‰ Picture unlocked!");
    }

    initShop();
  </script>
  <script src="/pages/scripts/include.js"></script>
</body>
</html>
